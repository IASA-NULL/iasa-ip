<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>IP</title>
    <link href="css/materialize.min.css" media="screen,projection" rel="stylesheet" type="text/css"/>
    <script>
        if (typeof module === 'object') {
            window.module = module;
            module = undefined;
        }
    </script>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/materialize.min.js"></script>
    <script>if (window.module) module = window.module;</script>
    <link href="css/mainUI/header.css" rel="stylesheet" type="text/css"/>
    <link href="css/mainUI/common.css" rel="stylesheet" type="text/css"/>
    <link id="theme" rel="stylesheet" type="text/css">
</head>

<body>
<div id="wrapper">
    <header id="titlebar">
        <div id="drag-region">
            <div id="window-title">
                <span id="appTitle">IP 5.0.0</span>
            </div>
            <div id="window-controls">
                <div class="button" id="min-button">
                    <span>&#xE921;</span>
                </div>
                <div class="button" id="close-button">
                    <span>&#xE8BB;</span>
                </div>
            </div>
        </div>
    </header>

    <div class="splash">
        <svg height="300" overflow="hidden" viewBox="390 165 420 420"
             width="300" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <clipPath id="clip0">
                    <path clip-rule="evenodd" d="M37-46 922-46 922 683 37 683Z" fill-rule="evenodd"/>
                </clipPath>
            </defs>
            <g clip-path="url(#clip0)" transform="translate(-37 46)">
                <path d="M518.975-45.1008 921.232 130.36 680.367 682.563 278.11 507.103Z" fill="#8F3EBC"
                      fill-rule="evenodd" id="splashBack1"/>
                <path d="M278.072-45.1008 680.329 130.36 439.463 682.563 37.2061 507.103Z" fill="#C497DD"
                      fill-rule="evenodd" id="splashBack2"/>
                <path d="M669.803 267.141 693.087 267.141C703.081 267.141 710.31 269.538 714.775 274.331 719.241 279.125 721.473 287.38 721.473 299.097 721.473 310.175 719.241 318.217 714.775 323.224 710.31 328.23 702.655 330.733 691.811 330.733L669.803 330.733ZM609.841 225.918 609.841 440.662 669.803 440.662 669.803 369.4 700.423 369.4C727.427 369.4 748.052 363.169 762.299 350.706 776.545 338.243 783.669 319.975 783.669 295.901 783.669 273.106 776.599 255.744 762.458 243.813 748.318 231.883 727.108 225.918 698.828 225.918ZM508.133 225.918 508.133 440.662 568.414 440.662 568.414 225.918ZM378 73 902 73 902 598 378 598Z"
                      fill-rule="evenodd"
                      id="splashFont"/>
            </g>
        </svg>
    </div>

    <script type="text/javascript">
        const verNum = 500;
        const settings = require('electron-settings');
        const ipModule = require('./changeIp.js');
        const {ipcRenderer} = require('electron');
        let adpArr = [0];


        $(document).ready(() => {
            if (window.matchMedia('(prefers-color-scheme:dark)').matches) document.getElementById("theme").href = "css/mainUI/dark.css";
            else document.getElementById("theme").href = "css/mainUI/light.css";
            $.fn.pressEnter = function (fn) {
                return this.each(() => {
                    $(this).bind('enterPress', fn);
                    $(this).keyup(e => {
                        if (e.keyCode === 13) {
                            $(this).trigger("enterPress");
                        }
                    })
                });
            };
            $('#chg2').hide();
            $('#old').hide();
            chgView();
            chkUpdate();
            $('#stuId').pressEnter(submitWelcome);
            if (!settings.get('ip')) showWelcome();
            else if (!settings.get('adp')) getAdapter();
            if (settings.get('svc')) {
                $('#svc').children('label').click()
            }
            $("#svc").on("click", () => {
                const status = $("#svc").find('input').is(':checked');
                console.log(status);
                if (status) settings.set('svc', true);
                else settings.set('svc', false);
            });
            document.getElementById('close-button').addEventListener('click', () => {
                window.close();
            });
            document.getElementById('min-button').addEventListener('click', () => {
                ipcRenderer.send('hide', 'IP');
            });
        });

        function openUpd() {
            const {shell} = require('electron');
            shell.openExternal('https://iasa.kr/program/ip');
        }

        function chkUpdate() {
            if (settings.get('aupd') !== true) return;
            $.ajax('https://api.iasa.kr/ip/ver', {
                success: data => {
                    const ver = parseInt(data);
                    if (ver > verNum) {
                        $('#modal2').modal({dismissible: false});
                        $('#modal2').modal('open');
                        $('#new').hide();
                        $('#old').show();
                    }
                }
            });
        }

        function chgView() {
            if (ipModule.getCurrentState() === 0) {
                $('#ipIcon').attr('src', './res/school.png');
                $('#ipInfo').html('IP를 교내 IP로 변경합니다.');
            } else {
                $('#ipIcon').attr('src', './res/house.png');
                $('#ipInfo').html('IP를 교외 IP로 변경합니다.');
            }
        }

        function showSec(v) {
            $('.section').removeClass('showSection').removeClass('initShowSection').addClass('hideSection')
            $('#sec' + String(v)).removeClass('hideSection').removeClass('initShowSection').addClass('showSection')
            setTimeout(() => {
                $('.section').addClass('novisible');
                $('#sec' + String(v)).removeClass('novisible');
            }, 300);
            chkUpdate();
        }

        function showMain() {
            showSec(1);
        }

        async function chgIp() {
            showSec(2);
            if (ipModule.getCurrentState() === 0) await ipModule.changeToSchool();
            else await ipModule.changeToOut();
            $('#chg1').show();
            $('#chg2').hide();
            setTimeout(() => {
                $('#chg1').fadeOut(200);
                chgView();
            }, 1200);
            setTimeout(() => {
                $('#chg2').fadeIn(200)
            }, 1400);
            setTimeout(() => {
                showMain();
            }, 1600);
        }

        function showSet() {
            showSec(3);
        }

        function showCred() {
            showSec(4);
        }

        function showWelcome() {
            settings.set('svc', true);
            showSec(5);
            $('#sec5').removeClass('hideSection').removeClass('showSection').removeClass('novisible').addClass('initShowSection');
            setTimeout(() => {
                document.getElementById("stuId").focus();
            }, 1500);
        }

        function submitError() {
            $('#stuId').removeClass('validate').addClass('invalid');
        }

        function submitWelcome() {
            let a, b, c, su, ip, gate;
            const stuId = $('#stuId').val();
            if (stuId == null) submitError();
            else if (stuId.length !== String(parseInt(stuId)).length) submitError();
            else if (stuId.length < 4) submitError();
            else if (stuId.length > 5) submitError();
            else {
                if (stuId.length === 4) {
                    a = Math.floor(parseInt(stuId) / 1000);
                    b = Math.floor(parseInt(stuId) / 100 % 10);
                    c = parseInt(stuId) % 100;
                }
                if (stuId.length === 5) {
                    a = Math.floor(parseInt(stuId) / 10000);
                    b = Math.floor(parseInt(stuId) / 100 % 10);
                    c = parseInt(stuId) % 100;
                }
                if (a > 3 || a < 1) submitError();
                else if (b > 5 || b < 1) submitError();
                else if (c > 16 || c < 1) submitError();
                else {
                    su = 9 + c + (b - 1) * 16;
                    if (a === 1) {
                        ip = '10.140.82.' + String(su);
                        gate = '10.140.82.254';
                    }
                    if (a === 2) {
                        ip = '10.140.83.' + String(su);
                        gate = '10.140.83.254';
                    }
                    if (a === 3) {
                        ip = '10.140.84.' + String(su);
                        gate = '10.140.84.254';
                    }
                    settings.set('ip', ip);
                    settings.set('gate', gate);
                    settings.set('svc', true);
                    settings.set('aupd', true);
                    getAdapter();
                }
            }
        }

        function agreeResetIP() {
            const {ipcRenderer} = require('electron');
            ipcRenderer.send('resetApplication', 'IP');
        }

        function resetIp() {
            $('#modal1').modal();
            $('#modal1').modal('open');
        }

        function getAdapter() {
            const os = require('os');
            const dat = os.networkInterfaces();
            if (dat['Wi-Fi'] != null) {
                settings.set('adp', 'Wi-Fi');
                showMain();
            } else {
                let i = 1;
                for (let n in dat) {
                    $('select').append('<option class="waves-effect" value="' + String(i) + '">' + n + '</option>');
                    adpArr.push(n);
                    i += 1;
                }
                $('select').formSelect();
                showSec(6);
            }
            chkUpdate();
        }

        function submitAdapter() {
            const idx = parseInt($('select').val());
            if (!idx) return;
            settings.set('adp', adpArr[idx]);
            showSec(1);
        }
    </script>

    <div class="modal" id="modal1">
        <div class="modal-content">
            <h4>IP를 초기화하면 모든 설정이 지워집니다.</h4>
            <p>정말로 IP를 초기화 하시겠어요?</p>
        </div>
        <div class="modal-footer">
            <a class="modal-close waves-effect waves-light btn-flat" onclick="agreeResetIP();">예</a>
            <a class="modal-close waves-effect waves-light btn-flat" href="#">아니요</a>
        </div>
    </div>

    <div class="modal" id="modal2">
        <div class="modal-content">
            <h4>새 버전이 있습니다.</h4>
        </div>
        <div class="modal-footer">
            <a class="modal-close waves-effect waves-light btn-flat" onclick="openUpd();">다운로드</a>
        </div>
    </div>

    <div class="frame">
        <div class="container">
            <div class="fixCon">
                <div class="initShowSection section" id="sec1">
                    <div class="row">
                        <div class="col s12 m6 obj" onclick="chgIp();">
                            <div class="waves-effect" style="width:100%;">
                                <div style="display:inline-block;">
                                    <div style="float:left;width:140px;">
                                        <img id="ipIcon"
                                             style="margin-left:20px;margin-top:20px;margin-bottom:20px;height:90px;">
                                    </div>
                                    <div style="float:left;margin-left:0;">
                                        <p class="text">IP 변경하기</p>
                                        <p class="info" id="ipInfo"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col s12 m6 obj" onclick="chgIp();">
                            <div class="waves-effect" style="width:100%;">
                                <div style="display:inline-block;">
                                    <div style="float:left;width:140px;">
                                        <img src="res/school.png"
                                             style="margin-left:20px;margin-top:20px;margin-bottom:20px;height:90px;">
                                    </div>
                                    <div style="float:left;margin-left:0;">
                                        <p class="text">VPN 설정</p>
                                        <p class="info" id="ipInfo2">VPN을 설정합니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col s12 m6 obj" onclick="showSet();">
                            <div class="waves-effect" style="width:100%;">
                                <div style="display:inline-block;">
                                    <div style="float:left;width:140px;">
                                        <img src="res/op.png"
                                             style="margin-left:20px;margin-top:20px;margin-bottom:20px;height:90px;">
                                    </div>
                                    <div style="float:left;margin-left:0;">
                                        <p class="text">설정</p>
                                        <p class="info">옵션을 변경합니다.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col s12 m6 obj" onclick="showCred();">
                            <div class="waves-effect" style="width:100%;">
                                <div style="display:inline-block;">
                                    <div style="float:left;width:140px;">
                                        <img src="res/info.png"
                                             style="margin-left:20px;margin-top:20px;margin-bottom:20px;height:90px;">
                                    </div>
                                    <div style="float:left;margin-left:0;">
                                        <p class="text">정보</p>
                                        <p class="info">프로그램 정보를 엽니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hideSection novisible section" id="sec2" style="width:100%;height:80vh;min-height:100%;">
                    <div style="width:100%;height:100%;">
                        <div class="valign-wrapper center-align" style="width:100%;height:100%;">
                            <div id="chg1" style="width:100%;">
                                <h1>IP 변경중...</h1>
                                <div class="preloader-wrapper big active">
                                    <div class="spinner-layer spinner-blue-only">
                                        <div class="circle-clipper left">
                                            <div class="circle"></div>
                                        </div>
                                        <div class="gap-patch">
                                            <div class="circle"></div>
                                        </div>
                                        <div class="circle-clipper right">
                                            <div class="circle"></div>
                                        </div>
                                    </div>
                                </div>
                                <p>잠시만 기다려 주세요.</p>
                            </div>
                            <div id="chg2" style="width:100%;">
                                <h1>모두 완료되었습니다!</h1>
                                <img src="./res/done.png" style="width:150px;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hideSection novisible section" id="sec3"
                     style="width:100%;height:80vh;min-height:444px;margin-bottom:20px;">
                    <div style="width:100%;height:100%;">
                        <div class="valign-wrapper center-align" style="width:100%;height:100%;">
                            <div style="width:100%;">
                                <h1>설정</h1>
                                <h4>IP 자동변경</h4>
                                <div class="switch" id="svc">
                                    <label>
                                        <input type="checkbox">
                                        <span class="lever"></span>
                                    </label>
                                </div>
                                <br>
                                <a class="waves-effect waves-light btn btn-large btn-flat lighten-1"
                                   onclick="resetIp()">IP
                                    초기화</a>
                                <a class="waves-effect waves-light btn btn-large btn-flat lighten-1"
                                   onclick="showMain()">확인</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hideSection novisible section" id="sec4"
                     style="width:100%;height:80vh;min-height:450px;margin-bottom:20px;">
                    <div style="width:100%;height:100%;">
                        <div class="valign-wrapper center-align" style="width:100%;height:100%;">
                            <div style="width:100%;">
                                <img src="res/IPLogo.png" style="width:120px;">
                                <p>5.0.0</p>
                                <p id="new">최신 버전입니다.</p>
                                <p id="old">새 버전이 있습니다. <a onclick="openUpd()">다운로드</a></p>
                                <p>개발 : 4기 이서현</p>
                                <img id="credit-white" src="res/credit_white.png" style="width:100px;">
                                <img id="credit-black" src="res/credit_black.png" style="width:100px;">
                                <br>
                                <a class="waves-effect waves-light btn btn-large btn-flat lighten-1"
                                   onclick="showMain()">확인</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="hideSection novisible section" id="sec5"
                     style="width:100%;height:80vh;min-height:320px;margin-bottom:20px;">
                    <div style="width:100%;height:100%;">
                        <div class="valign-wrapper center-align" style="width:100%;height:100%;">
                            <div style="width:100%;">
                                <h1>환영합니다!</h1>
                                <p>계속하려면 학번을 입력해 주세요.</p>
                                <div class="row">
                                    <div class="input-field col offset-s4 s4">
                                        <input class="validate" data-error="올바른 학번을 입력해 주세요." id="stuId" type="text">
                                        <label for="stuId">학번</label>
                                    </div>
                                </div>
                                <a class="waves-effect waves-light btn btn-large btn-flat lighten-1"
                                   onclick="submitWelcome()">확인</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="hideSection novisible section" id="sec6"
                     style="width:100%;height:80vh;min-height:320px;margin-bottom:20px;">
                    <div style="width:100%;height:100%;">
                        <div class="valign-wrapper center-align" style="width:100%;height:100%;">
                            <div style="width:100%;">
                                <h3>어댑터를 자동으로 탐지할 수 없습니다.</h3>
                                <p>와이파이 어댑터를 선택해 주세요.</p>
                                <div class="row">
                                    <div class="input-field col s6 offset-s3">
                                        <select>
                                            <option disabled selected value="0">어댑터를 선택하세요</option>
                                        </select>
                                        <label>어댑터</label>
                                    </div>
                                </div>
                                <a class="waves-effect waves-light btn btn-large btn-flat lighten-1"
                                   onclick="submitAdapter()">확인</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>