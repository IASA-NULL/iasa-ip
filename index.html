<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>IP</title>
    <link href="css/materialize.min.css" media="screen,projection" rel="stylesheet" type="text/css"/>
    <script>
        if (typeof module === 'object') {
            window.module = module;
            module = undefined;
        }
    </script>
    <script src="js/materialize.min.js" type="text/javascript"></script>
    <script>if (window.module) module = window.module;</script>
    <link href="css/mainUI/header.css" rel="stylesheet" type="text/css"/>
    <link href="css/mainUI/common.css" rel="stylesheet" type="text/css"/>
    <link id="theme" rel="stylesheet" type="text/css">
</head>

<body>
<div id="wrapper">
    <header id="titlebar">
        <div id="drag-region">
            <div id="window-title">
                <span id="appTitle">IP 5.0.0</span>
            </div>
            <div id="window-controls">
                <div class="button" id="min-button">
                    <span>&#xE921;</span>
                </div>
                <div class="button" id="close-button">
                    <span>&#xE8BB;</span>
                </div>
            </div>
        </div>
    </header>

    <div class="splash">
        <svg height="300" overflow="hidden" viewBox="390 165 420 420"
             width="300" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <clipPath id="clip0">
                    <path clip-rule="evenodd" d="M37-46 922-46 922 683 37 683Z" fill-rule="evenodd"/>
                </clipPath>
            </defs>
            <g clip-path="url(#clip0)" transform="translate(-37 46)">
                <path d="M518.975-45.1008 921.232 130.36 680.367 682.563 278.11 507.103Z" fill="#8F3EBC"
                      fill-rule="evenodd" id="splashBack1"/>
                <path d="M278.072-45.1008 680.329 130.36 439.463 682.563 37.2061 507.103Z" fill="#C497DD"
                      fill-rule="evenodd" id="splashBack2"/>
                <path d="M669.803 267.141 693.087 267.141C703.081 267.141 710.31 269.538 714.775 274.331 719.241 279.125 721.473 287.38 721.473 299.097 721.473 310.175 719.241 318.217 714.775 323.224 710.31 328.23 702.655 330.733 691.811 330.733L669.803 330.733ZM609.841 225.918 609.841 440.662 669.803 440.662 669.803 369.4 700.423 369.4C727.427 369.4 748.052 363.169 762.299 350.706 776.545 338.243 783.669 319.975 783.669 295.901 783.669 273.106 776.599 255.744 762.458 243.813 748.318 231.883 727.108 225.918 698.828 225.918ZM508.133 225.918 508.133 440.662 568.414 440.662 568.414 225.918ZM378 73 902 73 902 598 378 598Z"
                      fill-rule="evenodd"
                      id="splashFont"/>
            </g>
        </svg>
    </div>

    <script type="text/javascript">
        const verNum = 500;
        const settings = require('electron-settings');
        const ipModule = require('./changeIp.js');
        const {ipcRenderer} = require('electron');
        let adpArr = [0];
        let betaView = false;

        function getTheme() {
            if (!settings.get('atheme')) {
                return window.matchMedia('(prefers-color-scheme:dark)').matches;
            } else {
                return !!settings.get('dtheme');
            }
        }

        function loadTheme() {
            if (getTheme()) document.getElementById("theme").href = "./css/mainUI/dark.css";
            else document.getElementById("theme").href = "./css/mainUI/light.css";
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadTheme();
            document.getElementById('chg2').style.display = 'none';
            chgView();
            chkUpdate();
            document.getElementById('stuId').addEventListener("keydown", e => {
                if (e.key === "Enter") submitWelcome();
            });
            if (settings.get('ver') !== 500) {
                M.Modal.init(document.getElementById('modal-new')).open();
                settings.set('ver', 500);
            }
            if (!settings.get('ip')) showWelcome();
            else if (!settings.get('adp')) getAdapter();
            if (settings.get('svc')) document.getElementById('svc').querySelector('label').click();
            if (!settings.get('atheme')) {
                document.getElementById('atheme').querySelector('label').click();
                document.getElementById('userTheme').style.display = 'none';
            }
            if (settings.get('dtheme')) document.getElementById('dtheme').querySelector('label').click();
            if (!settings.get('nvpn')) document.getElementById('vpn').querySelector('label').click();
            document.getElementById('svc').addEventListener("click", () => {
                settings.set('svc', document.getElementById('svc').querySelector('input').checked);
            });
            document.getElementById('vpn').addEventListener("click", () => {
                const status = document.getElementById('vpn').querySelector('input').checked;
                settings.set('nvpn', !status);
            });
            document.getElementById('atheme').addEventListener("click", () => {
                if (!document.getElementById('atheme').querySelector('input').checked) settings.set('atheme', true);
                else settings.set('atheme', false);
                if (settings.get('atheme')) document.getElementById('userTheme').style.display = '';
                else document.getElementById('userTheme').style.display = 'none';
                if (window.matchMedia('(prefers-color-scheme:dark)').matches ^ document.getElementById('dtheme').querySelector('input').checked) {
                    document.getElementById('dtheme').querySelector('label').click();
                    if (document.getElementById('dtheme').querySelector('input').checked) settings.set('dtheme', true);
                    else settings.set('dtheme', false);
                }
                loadTheme();
            });
            document.getElementById('dtheme').addEventListener("click", () => {
                const status = document.getElementById('dtheme').querySelector('input').checked;
                if (status) settings.set('dtheme', true);
                else settings.set('dtheme', false);
                loadTheme();
            });
            document.getElementById('close-button').addEventListener('click', () => {
                window.close();
            });
            document.getElementById('min-button').addEventListener('click', () => {
                ipcRenderer.send('hide', 'IP');
            });
        });

        function chkUpdate() {
            fetch('https://api.iasa.kr/ip/ver').then(res => res.text()).then(data => {
                const ver = parseInt(data);
                if (ver > verNum) {
                    ipcRenderer.send('update', 'IP');
                } else if (ver < verNum) {
                    if (!betaView) {
                        M.Modal.init(document.getElementById('modal-beta')).open();
                        betaView = true;
                    }
                }
            });
        }

        function chgView() {
            if (ipModule.getCurrentState() === 0) {
                document.getElementById('ipIcon').src = './res/school.png';
                document.getElementById('ipInfo').innerText = 'IP를 교내 IP로 변경합니다.';
            } else {
                document.getElementById('ipIcon').src = './res/house.png';
                document.getElementById('ipInfo').innerText = 'IP를 교외 IP로 변경합니다.';
            }
        }

        function showSec(v) {
            document.querySelectorAll('.section').forEach((el) => {
                el.classList.remove('showSection');
                el.classList.remove('initShowSection');
                el.classList.add('hideSection');
            });
            document.getElementById('sec' + String(v)).classList.remove('hideSection');
            document.getElementById('sec' + String(v)).classList.remove('initShowSection');
            document.getElementById('sec' + String(v)).classList.add('showSection');
            setTimeout(() => {
                document.querySelectorAll('.section').forEach((el) => {
                    el.classList.add('novisible');
                });
                document.getElementById('sec' + String(v)).classList.remove('novisible');
            }, 300);
            chkUpdate();
        }

        function showMain() {
            showSec(1);
        }

        function chgIp() {
            showSec(2);
            document.getElementById('chg1').style.display = '';
            document.getElementById('chg1').classList.remove('fadeout');
            document.getElementById('chg2').style.display = 'none';
            setTimeout(async () => {
                if (ipModule.getCurrentState() === 0) await ipModule.changeToSchool();
                else await ipModule.changeToOut();
                setTimeout(() => {
                    document.getElementById('chg1').classList.add('fadeout');
                    chgView();
                }, 200);
                setTimeout(() => {
                    document.getElementById('chg1').style.display = 'none';
                    document.getElementById('chg2').style.display = '';
                    document.getElementById('chg2').classList.add('fadein');
                }, 400);
                setTimeout(() => {
                    showMain();
                }, 600);
            }, 600);
        }

        function showSet() {
            showSec(3);
        }

        function showCred() {
            showSec(4);
        }

        function showWelcome() {
            settings.set('svc', true);
            showSec(5);
            document.getElementById('sec5').classList.remove('hideSection');
            document.getElementById('sec5').classList.remove('showSection');
            document.getElementById('sec5').classList.remove('novisible');
            document.getElementById('sec5').classList.add('initShowSection');
            setTimeout(() => {
                document.getElementById("stuId").focus();
            }, 1500);
        }

        function submitError() {
            document.getElementById('stuId').classList.add('invalid');
            document.getElementById('stuId').classList.remove('validate');
        }

        function submitWelcome() {
            let a, b, c, su, ip, gate;
            const stuId = document.getElementById('stuId').value;
            if (stuId == null) submitError();
            else if (stuId.length !== String(parseInt(stuId)).length) submitError();
            else if (stuId.length < 4) submitError();
            else if (stuId.length > 5) submitError();
            else {
                if (stuId.length === 4) {
                    a = Math.floor(parseInt(stuId) / 1000);
                    b = Math.floor(parseInt(stuId) / 100 % 10);
                    c = parseInt(stuId) % 100;
                }
                if (stuId.length === 5) {
                    a = Math.floor(parseInt(stuId) / 10000);
                    b = Math.floor(parseInt(stuId) / 100 % 10);
                    c = parseInt(stuId) % 100;
                }
                if (a > 3 || a < 1) submitError();
                else if (b > 5 || b < 1) submitError();
                else if (c > 16 || c < 1) submitError();
                else {
                    su = 9 + c + (b - 1) * 16;
                    if (a === 1) {
                        ip = '10.140.82.' + String(su);
                        gate = '10.140.82.254';
                    }
                    if (a === 2) {
                        ip = '10.140.83.' + String(su);
                        gate = '10.140.83.254';
                    }
                    if (a === 3) {
                        ip = '10.140.84.' + String(su);
                        gate = '10.140.84.254';
                    }
                    settings.set('ip', ip);
                    settings.set('gate', gate);
                    settings.set('svc', true);
                    settings.set('adp', 'Wi-Fi');
                    showMain();
                }
            }
        }

        function agreeResetIP() {
            const {ipcRenderer} = require('electron');
            ipcRenderer.send('resetApplication', 'IP');
        }

        function resetIp() {
            M.Modal.init(document.getElementById('modal-reset')).open();
        }

        function getAdapter() {
            const os = require('os');
            const dat = os.networkInterfaces();
            let i = 1;
            let adpHtml = `<option selected value="0">어댑터를 선택하세요</option>`;
            for (let n in dat) {
                adpHtml += `<option class="waves-effect" value="${String(i)}">${n}</option>`
                adpArr.push(n);
                i += 1;
            }
            document.getElementById('adpSel').innerHTML = adpHtml;
            M.FormSelect.init(document.getElementById('adpSel'));
            showSec(6);
            chkUpdate();
        }

        function submitAdapter() {
            const idx = parseInt(document.getElementById('adpSel').value);
            if (!idx) return;
            settings.set('adp', adpArr[idx]);
            showSec(1);
        }

        function showVpnSet() {
            showSec(7);
        }

        function showNew() {
            M.Modal.init(document.getElementById('modal-new')).open();
        }
    </script>

    <div class="modal" id="modal-reset">
        <div class="modal-content">
            <h4>IP를 초기화하면 모든 설정이 지워집니다.</h4>
            <p>정말로 IP를 초기화 하시겠어요?</p>
        </div>
        <div class="modal-footer">
            <a class="modal-close waves-effect waves-light btn-flat" onclick="agreeResetIP();">예</a>
            <a class="modal-close waves-effect waves-light btn-flat" href="#">아니요</a>
        </div>
    </div>

    <div class="modal" id="modal-new">
        <div class="modal-content">
            <h4>새로운 기능!</h4>
            <h5>5.0.0</h5>
            <p>VPN 설정이 추가되었습니다.</p>
            <p>속도가 매우 향상되었습니다.</p>
            <p>어댑터를 더 정확하게 잡아냅니다.</p>
            <p>자동 업데이트가 도입되었습니다.</p>
            <p>IP가 바뀔때 창이 닫히지 않는 문제를 해결했습니다.</p>
        </div>
        <div class="modal-footer">
            <a class="modal-close waves-effect waves-light btn-flat" href="#">닫기</a>
        </div>
    </div>

    <div class="modal" id="modal-beta">
        <div class="modal-content">
            <h4>베타 버전을 사용하고 있습니다.</h4>
            <p>베타 버전은 정식 버전보다 불안정할 수 있습니다.</p>
        </div>
        <div class="modal-footer">
            <a class="modal-close waves-effect waves-light btn-flat" onclick="">닫기</a>
        </div>
    </div>

    <div class="frame">
        <div class="container">
            <div class="fixCon">
                <div class="initShowSection section" id="sec1">
                    <div class="row">
                        <div class="col s12 m6 obj" onclick="chgIp();">
                            <div class="waves-effect waves-light main-menu" style="width:100%;">
                                <div style="display:inline-block;">
                                    <div style="float:left;width:140px;">
                                        <img id="ipIcon"
                                             style="margin-left:20px;margin-top:20px;margin-bottom:20px;height:90px;">
                                    </div>
                                    <div style="float:left;margin-left:0;">
                                        <p class="text">IP 변경하기</p>
                                        <p class="info" id="ipInfo"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col s12 m6 obj" onclick="showVpnSet();">
                            <div class="waves-effect waves-light main-menu" style="width:100%;">
                                <div style="display:inline-block;">
                                    <div style="float:left;width:140px;">
                                        <img src="res/vpn.png"
                                             style="margin-left:20px;margin-top:20px;margin-bottom:20px;height:90px;">
                                    </div>
                                    <div style="float:left;margin-left:0;">
                                        <p class="text">VPN 설정</p>
                                        <p class="info" id="ipInfo2">VPN을 설정합니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col s12 m6 obj" onclick="showSet();">
                            <div class="waves-effect waves-light main-menu" style="width:100%;">
                                <div style="display:inline-block;">
                                    <div style="float:left;width:140px;">
                                        <img src="res/op.png"
                                             style="margin-left:20px;margin-top:20px;margin-bottom:20px;height:90px;">
                                    </div>
                                    <div style="float:left;margin-left:0;">
                                        <p class="text">설정</p>
                                        <p class="info">옵션을 변경합니다.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col s12 m6 obj" onclick="showCred();">
                            <div class="waves-effect waves-light main-menu" style="width:100%;">
                                <div style="display:inline-block;">
                                    <div style="float:left;width:140px;">
                                        <img src="res/info.png"
                                             style="margin-left:20px;margin-top:20px;margin-bottom:20px;height:90px;">
                                    </div>
                                    <div style="float:left;margin-left:0;">
                                        <p class="text">정보</p>
                                        <p class="info">프로그램 정보를 엽니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hideSection novisible section" id="sec2" style="width:100%;height:80vh;min-height:100%;">
                    <div style="width:100%;height:100%;">
                        <div class="valign-wrapper center-align" style="width:100%;height:100%;">
                            <div id="chg1" style="width:100%;">
                                <h1>IP 변경중...</h1>
                                <div class="preloader-wrapper big active">
                                    <div class="spinner-layer spinner-blue-only">
                                        <div class="circle-clipper left">
                                            <div class="circle"></div>
                                        </div>
                                        <div class="gap-patch">
                                            <div class="circle"></div>
                                        </div>
                                        <div class="circle-clipper right">
                                            <div class="circle"></div>
                                        </div>
                                    </div>
                                </div>
                                <p>잠시만 기다려 주세요.</p>
                            </div>
                            <div id="chg2" style="width:100%;">
                                <h1>모두 완료되었습니다!</h1>
                                <img src="./res/done.png" style="width:150px;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hideSection novisible section" id="sec3"
                     style="width:100%;height:80vh;min-height:444px;margin-bottom:20px;">
                    <div style="width:100%;height:100%;">
                        <div class="valign-wrapper center-align" style="width:100%;height:100%;">
                            <div style="width:100%;">
                                <h1>설정</h1>
                                <h4>IP 자동변경</h4>
                                <div class="switch" id="svc">
                                    <label>
                                        <input type="checkbox">
                                        <span class="lever"></span>
                                    </label>
                                </div>
                                <br>
                                <h4>시스템 테마 사용</h4>
                                <div class="switch" id="atheme">
                                    <label>
                                        <input type="checkbox">
                                        <span class="lever"></span>
                                    </label>
                                </div>
                                <br>
                                <div id="userTheme">
                                    <h4>다크 테마</h4>
                                    <div class="switch" id="dtheme">
                                        <label>
                                            <input type="checkbox">
                                            <span class="lever"></span>
                                        </label>
                                    </div>
                                </div>
                                <br>
                                <a class="waves-effect waves-light btn btn-large btn-flat lighten-1"
                                   onclick="resetIp();">IP 초기화</a>
                                <a class="waves-effect waves-light btn btn-large btn-flat lighten-1"
                                   onclick="getAdapter();">어댑터 수동 설정</a>
                                <a class="waves-effect waves-light btn btn-large btn-flat lighten-1"
                                   onclick="showMain();">확인</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hideSection novisible section" id="sec4"
                     style="width:100%;height:80vh;min-height:450px;margin-bottom:20px;">
                    <div style="width:100%;height:100%;">
                        <div class="valign-wrapper center-align" style="width:100%;height:100%;">
                            <div style="width:100%;">
                                <img src="res/IPLogo.png" style="width:120px;">
                                <p>5.0.0</p>
                                <p>최신 버전입니다.</p>
                                <p>개발 : 4기 이서현</p>
                                <img id="credit-white" src="res/credit_white.png" style="width:100px;">
                                <img id="credit-black" src="res/credit_black.png" style="width:100px;">
                                <br>
                                <a class="waves-effect waves-light btn btn-large btn-flat lighten-1"
                                   onclick="showNew();">새로운 기능</a>
                                <a class="waves-effect waves-light btn btn-large btn-flat lighten-1"
                                   onclick="showMain()">확인</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="hideSection novisible section" id="sec5"
                     style="width:100%;height:80vh;min-height:320px;margin-bottom:20px;">
                    <div style="width:100%;height:100%;">
                        <div class="valign-wrapper center-align" style="width:100%;height:100%;">
                            <div style="width:100%;">
                                <h1>환영합니다!</h1>
                                <p>계속하려면 학번을 입력해 주세요.</p>
                                <div class="row">
                                    <div class="input-field col offset-s4 s4">
                                        <input class="validate" data-error="올바른 학번을 입력해 주세요." id="stuId" type="text">
                                        <label for="stuId">학번</label>
                                    </div>
                                </div>
                                <a class="waves-effect waves-light btn btn-large btn-flat lighten-1"
                                   onclick="submitWelcome()">확인</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="hideSection novisible section" id="sec6"
                     style="width:100%;height:80vh;min-height:320px;margin-bottom:20px;">
                    <div style="width:100%;height:100%;">
                        <div class="valign-wrapper center-align" style="width:100%;height:100%;">
                            <div style="width:100%;">
                                <h3>사용할 어댑터를 선택해 주세요.</h3>
                                <div class="row">
                                    <div class="input-field col s6 offset-s3">
                                        <select id="adpSel"></select>
                                        <label>어댑터</label>
                                    </div>
                                </div>
                                <a class="waves-effect waves-light btn btn-large btn-flat lighten-1"
                                   onclick="submitAdapter();">확인</a>
                                <a class="waves-effect waves-light btn btn-large btn-flat lighten-1"
                                   onclick="showMain();">취소</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hideSection novisible section" id="sec7"
                     style="width:100%;height:80vh;min-height:450px;margin-bottom:20px;">
                    <div style="width:100%;height:100%;">
                        <div class="valign-wrapper center-align" style="width:100%;height:100%;">
                            <div style="width:100%;">
                                <h1>VPN 설정</h1>
                                <h4>게임 실행시 VPN 자동연결</h4>
                                <div class="switch" id="vpn">
                                    <label>
                                        <input type="checkbox">
                                        <span class="lever"></span>
                                    </label>
                                </div>
                                <br>
                                <a class="waves-effect waves-light btn btn-large btn-flat lighten-1"
                                   onclick="">VPN 수동 연결</a>
                                <a class="waves-effect waves-light btn btn-large btn-flat lighten-1"
                                   onclick="showMain();">확인</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>